# 数据链路层
数据链路层使用的信道:
* 点对点信道:用于一对一的通信方式
* 广播信道:一对多的广播通信方式.由于广播信道上连接的主机很多,所以必须使用专用的**共享信道协议**来协调这些主机的数据发送

不同的链路层可能采用不同的数据链路层协议

## 一. 使用点对点信道的数据链路层
### 1.数据链路和帧
* 链路: 链路是一条无源的点到点的物理线路段,中间没有任何其他的交换节点
    * 一条链路只是一条通路的一个组成部分
* 数据链路是 物理线路 + 通信协议.
    * 把实现通信协议的硬件和软件加到链路上,就构成了数据链路.
    * 最常用的方法是使用**适配器也就是网卡**来实现这些协议的硬件和软件
* 帧是数据链路层按照具体协议要求由比特流装配而成的.
    * 数据是一帧一帧地传送的,当出现差错时,就可以只将有差错的帧重传一次,从而避免将全部数据进行重传
### 2. 数据链路层的三个基本问题
数据链路层有许多种协议,但三个基本问题是公共的:
1. 封装成帧
2. 透明传输
3. 差错控制

#### 1. 封装成帧
* 封装成帧就在在一段数据的前后分别添加首部和尾部,
* 首部和尾部的重要作用就是进行**帧定界**

![](https://ws1.sinaimg.cn/large/0077h8xtly1fr7pniddyyj30ww0eawge.jpg)

##### 关于帧的几种方法

1. 用控制字符进行帧定界
    * 当数据是由可打印的ASCII码组成的文本文件时,可以用特殊的控制字符表示**帧定界符**,一个放在帧首部表示开始,一个放在尾部表示帧的结束


![](https://ws1.sinaimg.cn/large/0077h8xtly1fr7q1p23gdj30y90au75i.jpg)

2. 帧同步
    * 帧同步是为了是接收方能够从收到的比特流中**准确区别出一帧的开始和结束**
    * 因此帧的设计必须要有帧首和帧尾的标识方法.另外为了检测传输中出现的差错和保持帧传输的有序性,帧的结构设计中还要包括校验信息和帧序号
    * 实现帧同步的四种方法:
        1. 字节计数法
        2. 字符填充法
        3. 比特填充法
        4. 违法编码法

字节计数法    
* 以一个特殊的字符表示一帧的开始(比如SOH控制字符),以一个专门的字段表示一帧的字节数.接收方可以通过表征帧开始的特殊字符区别出帧的开始和帧的字节数,从而确定帧的终止位置.
* 这种帧同步方法不会引起数据信息与其他控制信息的混淆,因而不采用任何措施就可以实现数据的透明性,任何数据都可以不受限制地传输.
* count字段具有脆弱性,其值若有差错将导致后面的比特都无法定位.

字符填充法
* 使用**特定字符**界定一帧的起始与终止.为了不使数据信息位中出现与特定字符相同的字符,可以在特性字符前加一个转义控制字符(如ESC),从而达到数据的透明性.
* 这种方法的特定字符依赖于所采用的字符编码集,故兼容性较差,实现起来复杂


比特填充法
* 用一组**特定的比特组合标志一帧的起始与终止**.为了不使数据信息中出现与特定的比特组合相同的比特串,可以在数据信息位中填充某一比特位,使两者不混淆
* 比特填充法很容易由硬件实现,其性能优于字符填充法

违法编码法(以太网使用这种方式)
* **采用特定的比特编码界定帧的起始和终止**,一般在物理层实现
* 曼彻斯特编码和差分曼彻斯特编码属于违法编码法
* 在物理层采用特定的比特编码方法时采用.比如曼彻斯特编码方法,将数据1编码成`高低电平对`,0编码成`低高电平对`. 而剩下的`低低 和 高高`电平对在数据比特中就是违法的,从而可以利用这些违法编码来界定帧的起始和终止位置

#### 2. 透明传输
* 传输中存在的问题: 如果数据中的某个字节的二进制代码恰好和SOH或EOT帧头和帧尾编码一样,数据链路层就会错误地获取帧的边界.  
![](https://ws1.sinaimg.cn/large/0077h8xtly1fr7r38t1n6j30z90e30uw.jpg)
* 解决上述问题的方法:**字节填充或字符填充**
    * 发送端的数据链路层在原始数据中出现的控制字符SOH或EOT的前面**插入一个转义字符ESC**.如果ESC也出现在数据中,就在转义字符的前面也加一个转义字符.
    * 接受端的数据链路层在将数据送往网络层之前删除所有插入的转义字符

#### 3. 差错检验
* 在一段时间内,`传输错误的比特数/传输总比特数 = 误码率`,误码率与信噪比有很大的关系
* 数据链路层的差错控制是保证相邻节点之间的传输差错控制在所允许的最小范围内

##### 循环冗余检验
在发送端首先将数据按每组k个划分为组，假设带传送的一组数据`M = 101001  (k = 6)`.我们在M的后面再添加供差错检测用的n位**冗余码**一起发送  
* 冗余码的计算:  暂略

##### 帧检验序列
* 在数据后面添加上冗余码成为帧检验序列
* 循环冗余检验CRC是一种常用的检错方法,而帧检验序列FCS是添加在数据后面的冗余码
* 在接收端对接受到的每一帧的CRC进行检验,若得出余数R=0,则判定此帧没有差错.R!=0就丢弃这一帧.
* 但这种检测方法并不能确定是哪一个或哪几个**比特**出现了差错

##### 差错检验的注意事项
* 仅仅使用循环冗余检验(CRC)只能做到无差错接受.
    * 无差错接受: 凡是接受的帧,都能以非常接近于1的概率认为这些帧在传输过程中没有产生差错
* 要做到可靠传输,就必须加上**确认和重传机制**


### 3. 流量控制
* 相邻节点的收发双方由于设备工作速率,缓冲区空间等差异,会出现发送方的发送速率大于接收方的接受速率现象.此时若不进行**发送方的速率控制**就会造成帧丢失
* 数据链路层的流量控制是**相邻节点之间**的数据链路的流量控制.
* 数据链路层的流量控制是对**发送数据流量**的控制,使发送方的发送速率不至于超过接收方的接收能力,达到双方的速率匹配

### 4. 数据链路控制
* 主要是提供各种服务质量参数,包括检测到不可纠正错误的平均时间,漏检差错率,传输延迟和吞吐量等.
* 常用的**差错**控制方法采用**自动重发请求ARQ**和**前向纠错技术FEC**
* 常用的**流量**控制方法采用停等协议和滑动窗口协议

#### 停等协议:最简单的流量控制协议
1. 发送方发出一帧,然后等待应答信号到达后再发送下一帧.  
2. 接收方每收到一帧后送回一个应答信号(ACK),表示愿意接受下一帧.**如果接收方不送回应答,发送方必须等待**

* 停等协议每次只发送一帧,然后等待接收方响应后才继续发送.当链路过长时,链路的利用率显著下降

#### 滑动窗口协议

* 滑动窗口协议采用的是不等待确认帧返回就连续发送多个帧的方案.由于允许发送多个未被确认的帧,帧号就需要采用多位二进制才能区分.
* 被发出的还暂时没有被确认的帧都有可能出错或丢失,因此发送方需要有发送缓冲区把这些暂时没被确认的帧保留下来,这样重发更方便
* 发送窗口用来指示发送方已发送但尚未确认的帧序号队列的界.
    * 尚未确认帧序号队列的上下界称为发送窗口的上下沿
    * 上下沿的步距称为窗口尺寸

#### 差错控制
* 差错控制是检测和纠正传输错误的机制.包含错误比特的帧经接收器校验后会被拒绝
* 差错控制的方法:
    * 肯定应答
    * 否定应答重发
    * 超时重发

#### 自动请求重发ARQ
ARQ利用差错检测技术自动对丢失帧和错误帧请求重发.
* 停等ARQ协议:停等流量控制技术+自动请求重发技术
* 根据停等ARQ协议,发送方发出**一帧**后必须等待应答信号,收到肯定ACK信号后继续发送下一阵,收到否定NAK信号或超时的情况下重新发送原来的帧  

![](https://ws1.sinaimg.cn/large/0077h8xtly1fr9u6xo575j30ys071dhl.jpg)

#### 后退N帧ARQ协议
* 后退N帧ARQ协议: 滑动窗口技术 + 自动请求重发ARQ技术.后退N帧是指**从出错处重发已经发送过的N个帧**

![](http://ww1.sinaimg.cn/large/0077h8xtly1fr9uazuuxfj30vu08gq5k.jpg)  
这里接受窗口大小为1,当第二帧出错时,2345帧都必须重发

#### 选择重发ARQ协议
* 滑动窗口技术 + 自动请求ARQ技术
* 设置接受窗口和发送窗口一样大,允许将未按照顺序到达的数据帧暂存,只是选择性地重发出错或丢失的帧,可以大大提高效率  
![](http://ww1.sinaimg.cn/large/0077h8xtly1fr9ukg99eoj30xi08v77b.jpg)

#### 差错控制技术
* 两类噪声:
    * 一类是信道所固有的,持续存在的随机热噪声
    * 一类是由于外界特定的短暂原因造成的冲击噪声
* `误码率Pe = 发生差错的码原数 / 接受的总码元数`

#### 差错控制编码
* 差错控制编码有两类:
    * 检错码:能发现错误的编码
    * 纠错码:不仅能发现错误而且能自动纠正差错的编码

* 奇偶校验码(检错码)
    * 通过增加冗余位使得码字中的 **1**的个数保持奇数或偶数的编码方法
    * 使用时可分为
        * 垂直奇偶校验
        * 水平奇偶校验
        * 水平垂直奇偶校验

### HDLC协议
数据链路层协议分为两大类:
* 面向字符的链路控制规程
* 面向比特的链路控制规程

HDLC有三种类型的站,两种链路配置和三种数据传输方式

* 站
    * 主站:对链路进行控制,发出命令帧
    * 次站:在主站控制下进行操作,发出相应帧
    * 复合站:具有主站和次站的双重功能，即可发出命令帧也可发出响应帧。

* 链路配置
    * 非平衡配置:适于点-点和多点链路,由一个主站和一个或多个次站组成
    * 平衡配置:仅适用于点-点链路,由两个复合站组成

* 数据传输方式
    * 正常响应方式:适用于非平衡配置,只有主站才能启动数据传输过程,次站收到主站的询问命令才能发送数据
    * 异步响应方式:适用于非平衡配置,次站无需得到主站的明确指示就可以启动数据传输,但仍需要主站对线路进行管理
    * 异步平衡方式:适用于平衡配置,任何一个复合站都无需取得另一个复合站的允许就可以启动数据传输

![](http://ww1.sinaimg.cn/large/0077h8xtly1fra0ooocebj30ww0kj41y.jpg)

## 二.PPP协议
* 适用于点对点链路
* 可在同一条物理链路上同时支持多种**网络层协议**
* 可以在多种类型的链路上运行

### PPP协议的组成
* 一个将IP数据报封装到串行链路的方法
* 链路控制协议LCP(Link Control Protocol)
* 网络控制协议NCP

### PPP协议体系
* 采用高级数据链路控制协议HDLC作为点到点的串行链路上封装数据报的基本方法
* 采用链路控制协议LCP用于启动线路,测试和关闭连接等
* 采用网络控制协议NCP建立和配置不同的网络层协议

### 透明传输问题
* 当PPP用于同步传输链路时,协议采用硬件完成**零比特填充**
* 用在异步传输时,使用**一种特殊的字符填充**

### PPP协议不提供使用序号和确认的可靠传输
* 在数据链路层出现差错的概率不大时,使用比较简单的PPP协议较为合理
* 在因特网环境下,PPP的信息字段**要放入IP数据报**,因此数据链路层的可靠传输并不能保证网络层的传输也是可靠的
* 帧检验序列FCS字段可保证无差错接受

### PPP协议的工作状态
* 当用户拨号接入ISP时,路由器的调制解调器对拨号做出确认并建立一条物理链接
* PC机向路由器发送一系列的LCP分组(封装成多个PPP帧)
* 这些分组及其响应选择一些PPP参数进行网络层配置,NCP给新接入的PC机分配一个临时的IP地址,使PC机成为因特网上的一个主机
* 通信完毕后,NCP释放网络层连接,收回原来分配出去IP地址.接着LCP释放数据链路层链接,最后失望物理层链接

**PPP协议不是纯粹的数据链路层协议,它还包含了物理层和网络层内容**

* LLC和MAC子层的功能分解主要是将数据链路层功能中与硬件有关的部分和与硬件无关的部分区分开。  
![](http://ww1.sinaimg.cn/large/0077h8xtly1frb4rte2eqj30lr0eataq.jpg)    
![](http://ww1.sinaimg.cn/large/0077h8xtly1frb4tls31fj30ti0fxwfk.jpg)


#### 逻辑链路控制子层LLC
* 逻辑链路控制子层的规范包含在IEEE802.2标准中.这个标准与HDLC是兼容的,但帧的格式不同.这里的帧校验序列由MAC子层实现,因此也不包含在LLC的帧结构中.
* LLC与所在的局域网所采用的拓扑结构,传输介质以及介质访问控制方式无关,它完成数据链路管理,差错控制,流量控制和数据帧顺序控制的功能, 并为高层提供服务访问点
### 三.使用广播信道的数据链路层
* LLC提供三种服务:
    * 无确认连接的服务
    * 连接方式的服务
    * 有确认无连接的服务

* LLC的操作类型:
    * 使用无编号信息帧支持**无确认无连接**服务
    * 使用HDLC的异步平衡方式的操作支持**连接方式**的LLC服务.不支持HDLC的其他操作
    * 使用一种新的无编号帧(AC)支持**有确认无连接的服务**

#### IEEE802.3标准与以太网
* 在局域网和城域网中，所有的设备共享传输介质，因此当信道的使用产生竞争时，如何分配信道的使用权便成为关键的问题
* 数据链路层的介质访问控制子层被用来解决广播信道的分配问题,用来分配**传输介质使用权**的协议被称为MAC协议
* 以太网的核心技术是**它的随机争用型介质访问方法**,即CSMA/CD介质访问控制方法
    * 核心思想是**共享的公共传输介质**

## 三.局域网的数据链路层
* 局域网的特点:
    * 网络为一个单位所拥有
    * 地理范围和站点数目有限

###　数据链路层的两个子层
* 逻辑链路控制LLC子层
* 介质访问控制MAC子层(与接入到传输媒体有关的内容都放在MAC子层)
* **不管采用何种协议的局域网,对LLC子层来说都是透明的**

![](http://ww1.sinaimg.cn/large/0077h8xtly1frb6izpr1zj30y30gbac1.jpg)

### 适配器(网卡)的作用
* 又名通信适配器或网络接口卡
* 重要作用:
    * 进行串行/并行转换
    * 对数据进行缓存
    * 在计算机的操作系统安装设备驱动
    * 实现以太网协议


![](http://ww1.sinaimg.cn/large/0077h8xtly1frb6ldxky2j30vp0hpwgz.jpg)  
* 发送信息: CPU和存储器生成数据,把生成的数据并行通信到网卡,网卡把数据封装成帧发送到局域网进行串行通信



## CSMA/CD(载波监听多点接入/碰撞检测)协议
* 多点接入表示许多计算机以多点接入的方式连接在一根总线上。
* 载波监听是指每一个站在发送数据前先检测一下总线上是否有其他计算机在发送数据.如果有就暂时不发送数据,以免发生碰撞
* 碰撞检测就是计算机边发送数据边检测信道上的信号电压大小。可以检测到是否有两个站同时发送数据
    * 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。
* 
* 以太网采用广播的方式发送数据,总线上每个计算机都能收到发送方发送的数据,只有与发送的数据帧的首部写入的地址一致的计算机才接受数据,其他的计算机丢弃数据.**在具有广播特性的总线上实现了一对一通信**  

![](http://ww1.sinaimg.cn/large/0077h8xtly1frb6ufllsqj30wr0c6gnp.jpg)

* 以太网的两种重要措施:
    * 采用无连接服务:
        * 不必建立链接就可以发送数据
        * 对发送的数据帧不编号,也不要求对方发回确认
        * **因为局域网信道的质量很好,由信道质量导致差错的概率很小**

### 以太网提供的服务
* 以太网提供的服务是**不可靠的交付**,即尽最大努力的交付
* 接收方收到有差错的数据帧时就丢弃此帧.**差错的纠正由高层来决定**
* 以太网发送的数据都是用**曼彻斯特编码**

