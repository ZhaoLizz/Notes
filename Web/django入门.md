知识补充

### 浏览器浏览网页的基本过程

* 本质是网络通信

* 浏览器根据url发送http请求后获取到该页面的源代码文档(HTML等)
  * 服务器处理请求的能力就是通过web开发获取的
* 浏览器解析文档后以适当的形式展示给用户

![](http://ww1.sinaimg.cn/large/0077h8xtly1fup9b6rbd2j312g0nfn59.jpg)



## 创建项目

1. `cd xxx`
2. `django-admin startproject xxprojectname`,没报错就创建成功了
   * 成功后生成一个文件夹和manage.py文件
3. 启动服务 `python manage.py runserver [xxxx端口号默认8000]`

## 项目目录介绍

* 项目目录是项目的一个容器,包含项目最基本的一些配置
* **不建议修改目录名称**

![](http://ww1.sinaimg.cn/large/0077h8xtly1fupbzn533ij309i0bqaam.jpg)

* wsgi.py : 服务器网关接口,是python应用与Web服务器之间**通信的接口**
* urls.py : URL配置文件,Django项目中所有地址(页面)都需要我们自己去配置页面的URL
* settings.py 项目的 **总配置文件**,包含了数据库,Web应用,时间等各种配置
* \__init__.py: python中声明模块的文件,默认为空



```python
# settings.py
"""
Django settings for myblog project.

Generated by 'django-admin startproject' using Django 2.1.

For more information on this file, see
https://docs.djangoproject.com/en/2.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/2.1/ref/settings/
"""

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
# 项目根目录
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/2.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
# 安全码
SECRET_KEY = '($+pa%#kx^6jj3kf1ek^*l9=!t@0da45_k51(4mdn$cu4g#qig'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

# DEBUG = False的情况下,只有在允许列表中的用户能够访问服务器
ALLOWED_HOSTS = ['localhost']


# Application definition
# Django是由许多应用组成的,这里是自带的应用,如果我们创建了自己的应用,就要添加到这里
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

# 中间件,python自带的一些工具集,不用理会
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

#URL的根文件,指向urls.py文件
ROOT_URLCONF = 'myblog.urls'

# 关于模板的配置
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

# 和WSGI相关的东西都不用管
WSGI_APPLICATION = 'myblog.wsgi.application'


# Database
# https://docs.djangoproject.com/en/2.1/ref/settings/#databases
# 数据库配置,默认sqlite3
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/2.1/ref/settings/#auth-password-validators
# 密码认证相关
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization 国际化
# https://docs.djangoproject.com/en/2.1/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/2.1/howto/static-files/
# 静态文件的地址
STATIC_URL = '/static/'

```



## 创建应用

1. cd进入`manage.py`同级目录, `python manage.py startapp xxxxappname`

2. 添加应用名到`settings.py`的`INSTALLED_APPS`里面

   ![](http://ww1.sinaimg.cn/large/0077h8xtly1fupd0pbvu2j30z40hvad9.jpg)

### 应用目录介绍

	![](http://ww1.sinaimg.cn/large/0077h8xtly1fupd2tcfntj308w09x3yz.jpg)



* migrations: 数据迁移模块,自动生成,和数据库相关
* admin.py: 当前应用的后台管理系统配置文件

* apps.py : 当前应用的一些配置
* models.py : 数据模块,使用ORM框架

* test.py : 自动化测试模块,Djaogo提供了自动化测试的功能,在这里编写测试脚本
* views.py : 执行响应的**逻辑代码**模块,**项目中大部分代码都在这里**

### 创建第一个页面(响应)

1. 编写views.py,定义响应请求的方法
    * 每个响应对应一个函数,函数必须返回一个响应
    * 定义的响应函数必须存在一个参数,一般约定为request
    * 每个响应函数对应一个url
```python
from django.shortcuts import render
from django.http import HttpResponse

def index(request):
    return HttpResponse('Hello world',)
```

2. 在项目的urls.py中配置url,参数 :(响应方法的名称,方法的引用,(可选名称))

```python
from django.contrib import admin
from django.urls import path

import blog.views as bv

urlpatterns = [
    path('admin/', admin.site.urls),
    path('index/', bv.index),
]
```
3. 启动服务 `python manage.py runserver`
4. 然后就可以在浏览器中访问 `127.0.0.1:8000/index`页面了
   * 这里的index指的就是配置url里面的index路径, index指向bv.index函数

## 配置URL
```
比上个方法更易于管理的配置URL的方法(用于url很多,上文不方便的情况)
通过文件导入url
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
```

* 在**应用包**(blog)里创建一个`urls.py`文件
* 在**项目包**里的`urls.py`里,引入`include`函数,通过include函数导入**应用包**的urls.py文件

```python
# myblog / urls.py
from django.contrib import admin
from django.urls import path ,include


urlpatterns = [
    path('admin/', admin.site.urls),
    path('index/',include('blog.urls'))
]
```

* 在应用包下的urls.py设置url指向的函数

```python
# blog / urls.py
from django.urls import path
from . import views

urlpatterns = [
    path('index/', views.index)
]

```



* 启动服务`python manage.py runsever`

* 这时浏览器访问的路径就应该是两层index了:   `http://127.0.0.1:8000/index/index/`
  * 根urls.py是针对APP配置的URL的名称,是一级路径,即针对的该APP所有URL的总路径



## 创建第一个Templates

### Templates介绍

* Templates就是许多HTML文件

* 它使用了Django模板语言DTL
  * 当然也可以使用第三方模板如Jinja2

### 步骤

* 在**APP根目录**创建名为`Templates`的目录,在该目录下 **创建以APP名为名称的目录**,在该目录下创建HTML文件

  ![](http://ww1.sinaimg.cn/large/0077h8xtly1fuqbp4jwd5j30970djq3k.jpg)

* 在views.py返回`render(request,template_name,dict)` *翻译为渲染*

  * 第三个参数`dict类型`,是字典从后台传递到模板的参数,k是参数名,v是值.在templates包里的HTML中通过 `{{ xxxkey }}关键字`引用值

  ```python
  # blog/views.py
  from django.shortcuts import render
  from django.http import HttpResponse
  
  
  def index(request):
      # return HttpResponse('Hello world111',)
      return render(
          request,
          'blog/index.html',
          {'hello': 'Hello Blog! This value comes from dict'}
      )
  
  ```

  ```html
  # index.html
  
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <title>Title</title>
  </head>
  <body>
  {#数据来自views对请求的处理函数的参数#}
  <h1>{{ hello }}</h1>
  </body>
  </html>
  ```


## Models

### 基本介绍

* 一个Model对应数据库的一张表
* Django中的Models以**类**的形式表现
* 它包含了一些**基本字段**和数据的一些**行为**(即和数据库交互时不需要任何sql语句)

### 创建模型

* 在**APP应用根目录**下创建`models.py`,引入`models`模块

  * `from django.db import models`

* 创建类,继承`models.Model`,该类即是一张**数据表**,与数据库对应


* 在类中创建字段
  * `attr = models.CharField(max_length=64)`
  * 具体的字段属性如`TextField`去django models的文档看

  ```python
  #blog / models.py
  from __future__ import unicode_literals
  from django.db import models
    
  class Article(models.Model):
  	title = models.CharField(max_length=32,default='Title')
      content = models.TextField(null=True)
  ```


### 生成数据表

* `cd manage.py同级目录`
* `python manage.py makemigrations [xxxappname]`
  * 指定应用名的参数为可选,默认为所有应用的model生成数据表
* 再执行 `python manage.py migrate`

**查看生成信息:**

* 查看生成的数据表: Django在`app/migrations`目录下生成移植文件

  ```python
  # blog / migrations / 0001_initial.py
  class Migration(migrations.Migration):
  
      initial = True
  
      dependencies = [
      ]
  
      operations = [
          migrations.CreateModel(
              name='Article',
              fields=[
                  # 由于我们的models没有创建主键字段(参数primary_key=True),自动生成一个id主键
                  ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                  ('title', models.CharField(default='Title', max_length=32)),
                  ('content', models.TextField(null=True)),
              ],
          ),
      ]
  
  ```

* 查看SQL语句: `python manage.py sqlmigrate 应用名 文件id`

  * e.g. `python manage.py sqlmigrate blog 0001`

* 默认的sqlite3的数据库生成在项目根目录下的 `db.sqlite3`



### 页面呈现数据

* `views.py`中 `import models`

* `article = models.Article.objects.get(pk=1)` 从数据库中获取model对象 ,参数是主键

* `render(request,page,{'article' :article})`通过模板传送model对象到前端

  ```python
  # blog / views.py
  from django.shortcuts import render
  from django.http import HttpResponse
  
  from . import models
  
  def index(request):
      article = models.Article.objects.get(pk=1) # 从数据库中查询获取model对象
  
      return render(
          request,
          'blog/index.html',
          {'article': article}
      )
  
  ```

* 在前端HTML通过`{{article.title}}`调用

  ```html
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <title>Title</title>
  </head>
  <body>
  {#数据来自views对请求的处理函数的参数#}
  <h1>{{ article.title }}</h1>
  <h3>{{ article.content }}</h3>
  </body>
  </html>
  ```


## Admin

### 基本介绍

* Admin是Django自带的一个强大的 **自动化数据管理界面**
* 被授权的用户可以直接在Admin中 **操作数据库**

### 配置Admin

* 创建超级用户 : `python manage.py createsuperuser`
* Admin入口: `localhost:8000/admin`
  * 修改setting.py中`LANGUAGE_CODE = ‘zh_Hans’`可以把这个管理页面改为中文

### 配置应用

授权用户登录admin界面后,可以 **操作配置过的应用的数据库,即该应用的model对应的数据库**

* 在 **应用目录下** `admin.py`引入自身的`models`模块
* 在admin.py 注册model:  `admin.site.register(models.Article)`



### 修改数据默认显示名称

界面默认显示的是model对象信息,这样就很不方便  

我们希望能直接显示对象的域的信息,比如标题,内容等![](http://ww1.sinaimg.cn/large/0077h8xtly1fuqdbvz3e7j30bn04paa3.jpg)



**步骤**

* 在model类的`Article`类下添加方法

  * py3: `__str__(self)`
  * py2: `__unicode_(self)`
  * `return self.title`

  ```python
  # blog  / models.py
  from __future__ import unicode_literals
  from django.db import models
  
  class Article(models.Model):
      title = models.CharField(max_length=32,default='Title')
      content = models.TextField(null=True)
  
      def __str__(self):
          return self.title
  ```

  修改后就可以了



  ![](http://ww1.sinaimg.cn/large/0077h8xtly1fuqdhm6ggtj30a807e74e.jpg)

### 进阶: 使界面显示更多的信息

1. 在admin.py中创建admin配置类

   `classArticleAdmin(admin.ModelAdmin)`

2. 注册 `admin.site.register(Article,ArticleAdmin)`

3. 定义类成员变量显示其它字段信息: `list_display = ('title','content')`

```python
from django.contrib import admin
from blog.models import Article

class ArticleAdmin(admin.ModelAdmin):
    list_display = ('title','content')

admin.site.register(Article,ArticleAdmin)
```

### 过滤器

在admin的配置类中添加成员变量`list_filter = ('xxx字段名称' , )`,然后就会自动在admin网页出现过滤器选项

* 注意加逗号

```python
from django.contrib import admin
from blog.models import Article


class ArticleAdmin(admin.ModelAdmin):
    list_display = ('title', 'content', 'pub_time')
    list_filter = ('pub_time',)


admin.site.register(Article, ArticleAdmin)
```

![](http://ww1.sinaimg.cn/large/0077h8xtly1furppeb1uhj30b90bmt8w.jpg)

