## 计算机体系结构/内存分层体系

内存的层次结构(CPU可以访问的数据的位置):

* 寄存器和cache位于CPU内部,操作系统无法直接对其管理,速度快,容量小
* 主存(物理内存):操作系统本身在主存,容量大,速度相对寄存器慢. 不通电的时候数据就没了
* 硬盘(虚拟内存): 速度相对主存慢,容量最大,可以持续存储数据

![](http://ww1.sinaimg.cn/large/0077h8xtly1fvn01dwlapj30k30bdwig.jpg)

## 地址空间与地址生成

### 地址空间

* 物理地址空间
  * 直接对应硬件地址(比如内存条和硬盘的地址)
  * 物理地址空间的管理和控制由硬件来完成
* 逻辑地址空间
  * 一个运行的程序所拥有的内存范围
  * 起始地址为0,到地址MAX
  * 操作系统负责来把 逻辑地址空间映射到物理地址空间(给逻辑地址一个偏移量,使得程序中所有的逻辑地址都能正确地通过偏移量映射到物理地址
    * 通过编译器,把基于符号的地址空间变为基于逻辑地址的地址空间,
    * 操作系统进而完成逻辑地址到物理地址的映射

## 连续内存分配:内存碎片与分区的动态分配

### 内存碎片

定义: 不能被利用的空闲内存

- 外部碎片:在分配单元间的未使用内存
- 内部碎片:在分配单元中的未使用内存

### 连续内存的动态分配策略  

#### **第一适配**: 使用第一个可用空闲快

* ![](http://ww1.sinaimg.cn/large/0077h8xtly1fvn8cfwcoqj30jf0cwn3j.jpg)
* 需求: 
  * 按地址排序的空闲块列表
  * 分配需要寻找一个合适的分区
  * 重分配需要检查,看是否自由分区能合并于相邻的空闲分区

* 优势
  * 简单
  * 易于产生更大的空闲块,向着地址空间的结尾
* 劣势
  * 容易产生外部碎片(在两次连续内存分配的中间,可能产生空间比较小的空闲块,下次难以利用)
  * 具有不确定性



#### 最佳适配

* 选择内存中产生最小碎片的分配方式(比如需要分配400byte,这里选择500byte的空闲空间产生的100byte碎片最小)
* ![](http://ww1.sinaimg.cn/large/0077h8xtgy1fvn8ndul4nj30jj0buteu.jpg)
* 需求
  * 按尺寸排列的空闲块列表
  * 需要寻找一个合适的分区
  * 重分配需要搜索及合并于相邻的空闲分区
* 优势
  * 在分配许多小尺寸内存时非常有效
* 劣势
  * 容易产生外部碎片
  * 重分配慢
  * 容易产生很多非常微小的碎片

#### 最差适配

* 和最优适配相反,最差适配选择一个产生空闲块最大的空间
* 优势:在分配中等尺寸的内存块时效果最好
* 劣势
  * 重分配慢
  * 产生外部碎片
  * 倾向于破坏大的空闲块



## 连续内存分配: 压缩式与交换式碎片整理

### 压缩式碎片整理

把应用程序的内存空间挪动到紧凑的位置

![](http://ww1.sinaimg.cn/large/0077h8xtly1fvn9eq5cd4j30g70k9dph.jpg)

### 交换式碎片整理

特点:

* 利用磁盘(硬盘)作为虚拟内存

* 运行程序需要更多的内存
* 抢占等待的程序,回收它们的内存

![](http://ww1.sinaimg.cn/large/0077h8xtly1fvn9kon7mrj30ir0bf0wx.jpg)

示例中,p3正在运行,需要更多的内存,这时就把硬盘当做虚拟内存,把正在等待的程序占用的内存空间挪到虚拟内存中,给p3留出空间